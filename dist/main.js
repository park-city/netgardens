(()=>{"use strict";let e="",t="invis",n={};function a(e,t){for(let n of e){let e=document.createElement("div"),a=document.createElement("img");a.src="/static/profpics/"+n+".png";let i=document.createElement("a");i.innerText=n,i.href="#",e.appendChild(a),e.appendChild(i),t.appendChild(e)}}function i(){if(!e)return;let t=document.getElementById(e);for(let e of t.getElementsByClassName("sidebar"))e.classList.add("hidden");t.classList.add("hidden");let n=document.querySelector("nav a[data-id='browse']"),a=document.querySelector("nav a[data-id='parksel']");n.classList.remove("active"),a.classList.remove("active")}function l(){if(!e)return;let t=document.querySelector("nav a[data-id='parksel']");i(),t.classList.remove("active")}function o(e){let t=e.parentElement.dataset.id,a=n[t];console.assert(a,"park list not loaded?!"),Map_Init(a.tiles,a.map,a.gardens),document.querySelector("nav a[data-id='parksel']").innerText=name,l()}function r(e,t){let n=document.createElement("div");n.dataset.id=t;let i=document.createElement("img");i.classList.add("icon"),i.classList.add("tile"),i.src=e.icon,n.appendChild(i);let l=document.createElement("div");l.classList.add("name"),l.innerText=e.name,n.appendChild(l);let r=document.createElement("div");r.classList.add("desc"),r.innerText=e.desc,n.appendChild(r);let d=document.createElement("a");d.href="#",d.classList.add("button"),d.classList.add("action"),d.onclick=o,d.innerText="Visit",n.appendChild(d);let s=document.createElement("div");s.classList.add("properties");let c=document.createElement("div");c.classList.add("header"),c.innerText="Artists: ",s.appendChild(c);let u=document.createElement("div");u.classList.add("owners"),u.classList.add("content"),a(e.artists,u),s.appendChild(u);let f=document.createElement("div");f.classList.add("header"),f.innerText="Mappers: ",s.appendChild(f);let m=document.createElement("div");return m.classList.add("owners"),m.classList.add("content"),a(e.mappers,m),s.appendChild(m),n.appendChild(s),n}function d(e,t){let n=document.createElement("canvas");n.width=88,n.height=31,n.classList.add("icon");let i=n.getContext("2d",{alpha:!1});Render_FG_SiteLink_Single_Raw(i,0,0,t,e.color);let l=document.createElement("div");l.classList.add("name"),t.name?l.innerText=t.name:l.innerText=e.name;let o=document.createElement("div");o.classList.add("owners"),a(e.owners,o);let r=document.createElement("div");return r.appendChild(n),r.appendChild(l),r.appendChild(o),r}function s(){let e=document.querySelector("nav [data-id='login']"),n=e.querySelector("img"),a=e.querySelector("span"),i=t;i?(n.classList.remove("hidden"),n.src="/static/profpics/"+i+".png",a.innerText=i):(n.classList.add("hidden"),a.innerText="Log in")}function c(){document.addEventListener("DOMContentLoaded",(a=>{d3.json("/static/maps/park-info.json").then((e=>{n=e;let t=n["central-park"];Map_Init(t.tiles,t.map,t.gardens)})).then((()=>{Map_SetAutoScroll(.5,.5),function(){if(!e)return;let t=document.getElementById(e).querySelector(".sidebar[data-id='parksel'] > .fancylist");for(let e in n)t.appendChild(r(n[e],e))}()})),e="sidebars",i();for(let e of document.getElementsByClassName("collapsebtn"))e.addEventListener("pointerup",(e=>{i()}));let o=document.getElementsByClassName("advertise")[0];o.querySelector("[data-id='close']").addEventListener("pointerup",(e=>{o.classList.add("hidden")})),window.addEventListener("resize",(()=>{resize_canvas()}));let c=document.getElementsByTagName("nav")[0];c.querySelector("[data-id='logo']").addEventListener("pointerup",(e=>{e.preventDefault(),o.classList.remove("hidden")})),c.querySelector("[data-id='parksel']").addEventListener("pointerup",(t=>{t.preventDefault(),function(){if(!e)return;let t=document.getElementById(e),n=t.querySelector("[data-id='parksel']"),a=document.querySelector("nav a[data-id='parksel']");a.classList.contains("active")?l():(i(),t.classList.remove("hidden"),n.classList.remove("hidden"),a.classList.add("active"))}()}));let u=c.querySelector("[data-id='overlay']");u.addEventListener("pointerup",(e=>{e.preventDefault(),function(){let e=document.getElementsByTagName("nav")[0].querySelector("[data-id='overlay']");Garden_ToggleOverlay()?e.classList.add("active"):e.classList.remove("active")}()})),Garden_OverlayActive()&&u.classList.add("active"),c.querySelector("[data-id='browse']").addEventListener("pointerup",(t=>{t.preventDefault(),function(){if(!e)return;let t=document.getElementById(e),n=t.querySelector("[data-id='sitelist']"),a=document.querySelector("nav a[data-id='browse']");a.classList.contains("active")?function(){let e=document.querySelector("nav a[data-id='browse']");i(),e.classList.remove("active")}():(i(),t.classList.remove("hidden"),n.classList.remove("hidden"),a.classList.add("active"),function(){if(!e)return;let t=document.getElementById(e).querySelector("[data-id='sitelist']"),n=t.querySelector("[data-id='parkname']"),a=t.querySelector(".fancylist");n.innerText=document.querySelector("nav a[data-id='parksel']").innerText;let i=Coord_Lookup_Center(),l=Gardens_SortDistance(null,i.x,i.y);a.innerHTML="";for(let e of l){let t=e.tiles.filter((e=>e.is_core));t&&a.appendChild(d(e,t[0]))}}())}()})),s(),c.querySelector("[data-id='login']").addEventListener("pointerup",(e=>{e.preventDefault(),t=t?null:"invis",s(),i()}))}))}let u=0,f=0,m=64,h=64,p=0,v=0,y=[],g=[0,0],L=[0,0],E=!1,S=0,M=0,x=!1,w=0,T=0,C=[],k=[],b=[],q={},I=null,_=null,B=!1;function R(e,t){return(e%t+t)%t}function D(e,t){let n=(e+=u)/m,a=(t+=f)/32,i=Math.abs(n-Math.trunc(n)),l=Math.abs(a-Math.trunc(a));return a<0&&(l=1-l),n<0&&(i=1-i),Math.abs(Math.floor(n))%2^Math.abs(Math.floor(a))%2?i<=l||(a-=1):i>=1-l||(a-=1),n=Math.floor(n),a=Math.floor(a),a+=1,{x:n,y:a}}function F(e,t,n,a,i){a.is_tele&&(e.fillStyle="transparent",e.strokeStyle="gold",e.lineWidth=3,function(e,t,n,a){e.beginPath(),e.ellipse(t,n+32,41.6,20.8,0,0,2*Math.PI),e.fill(),e.stroke()}(e,t,n,a.orient))}function A(e,t,n,a,i){a.is_core&&(e.fillStyle="#00000066",e.fillRect(t-40,n+25.6,80,16),function(e,t,n,a,i){try{e.drawImage(q[a.img],t,n)}catch(l){e.strokeStyle="#000000",e.lineWidth=4,e.fillStyle=i,e.strokeRect(t,n,88,31),e.fillRect(t,n,88,31),e.fillStyle="black",e.font="14px sans-serif",e.textAlign="center",e.fillText(a.name,t+44,n+20,80)}}(e,Math.floor(t-44),Math.floor(n-15.5),a,i))}function G(e,t,n,a,i){e.beginPath(),i?(e.moveTo(t,n),e.lineTo(t-m,n+32),e.lineTo(t,n+h),e.lineTo(t+m,n+32)):(e.moveTo(t,n+32),e.lineTo(t+m,n+h),e.lineTo(t+128,n+32),e.lineTo(t+m,n)),e.closePath(),e.fill(),e.stroke()}function N(e,t,n,a,i){e.beginPath(),a%2^i%2?(e.moveTo(t,n+32),e.lineTo(t+m,n+h),e.lineTo(t+m,n)):(e.moveTo(t,n),e.lineTo(t,n+h),e.lineTo(t+m,n+32)),e.closePath(),e.fill(),e.stroke()}function P(e,t,n,a){e.drawImage(C[a],t,n,64,128)}function O(e,t,n,a){let i=0,l=0;for(let o of t){try{P(e,i,n,o)}catch(t){N(e,i,n,l,a),setTimeout((()=>{B=!0}),200)}i+=64,l+=1}}function W(e){var t;t=(e-v)/(1e3/60),0!=E&&(u+=0*t,f+=0*t);const n=document.getElementById("mapcanvas");if(!n.getContext)return;const a=n.getContext("2d",{alpha:!1});!function(e,t){e.globalCompositeOperation="source-over",e.clearRect(0,0,t.width,t.height);let n=Math.floor(R(-u,I.width)),a=Math.floor(R(-f,I.height));const i=[n,n-I.width,n,n-I.width],l=[a,a,a-I.height,a-I.height];for(let t=0;t<4;t+=1){let n=i[t],a=I.width,o=l[t],r=I.height;e.drawImage(I,0,0,a,r,n,o,a,r)}e.fillStyle="black",e.fillRect(I.width,0,9999999,9999999),e.fillRect(0,I.height,9999999,9999999)}(a,n),function(e){for(let t of b)for(let n of t.tiles){let a=n.y-1,i=2*Math.floor(n.x/2);0!=Math.floor(a%2)&&(i=2*Math.floor((n.x+1)/2));let l=i*m-u;a%2==0&&(l+=m),F(e,l,a*h/2-f,n,t.color)}}(a),function(e){if(window.matchMedia("(any-hover: none)").matches)return;let t=T-1,n=2*Math.floor(w/2);0!=Math.floor(t%2)&&(n=2*Math.floor((w+1)/2));let a=n*m-u,i=t*h/2-f;e.fillStyle="transparent",e.strokeStyle="#00000066",e.lineWidth=5,G(e,a,i,0,t%2)}(a),function(e){if(!x)return;let t=M-1,n=2*Math.floor(S/2);0!=Math.floor(t%2)&&(n=2*Math.floor((S+1)/2));let a=n*m-u,i=t*h/2-f;e.fillStyle="transparent",e.strokeStyle="#000000",e.lineWidth=5,G(e,a,i,0,t%2)}(a),function(e){for(let t of b)for(let n of t.tiles){if(!n.is_core)continue;let a=n.y-1,i=2*Math.floor(n.x/2);0!=Math.floor(a%2)&&(i=2*Math.floor((n.x+1)/2));let l=i*m-u;a%2==0&&(l+=m),A(e,l,a*h/2-f,n,t.color)}}(a),v=e,window.requestAnimationFrame(W),B&&(a.clearRect(0,0,I.width,I.height),function(e){B=!1,e.fillStyle="#B0E0E6",e.strokeStyle="#FFFFFF";let t=-96,n=0;for(const a of k)O(e,a,t,n),t+=32,n+=1;for(let a=0;a<=2;a+=1)O(e,k[a],t,n),t+=32,n+=1}(_))}function X(e){1==e.buttons&&(y=[e.offsetX,e.offsetY],L=[u,f],E=!1)}function Y(e){if(g=[e.offsetX-y[0],e.offsetY-y[1]],Math.abs(g[0])+Math.abs(g[1])<16){let e=D(y[0],y[1]);S==e.x&&M==e.y?x=!x:(S=e.x,M=e.y,x=!0),x?Info_Show():Info_Hide()}j(e)}function H(e){const t=document.getElementById("mapcanvas");0!=e.pressure&&0==e.buttons||1==e.buttons?(t.classList.remove("clickable"),g=[e.offsetX-y[0],e.offsetY-y[1]],u=L[0]-g[0],f=L[1]-g[1]):j(e)}function j(e){const t=e.clientX,n=e.clientY,a=document.getElementById("mapcanvas"),i=D(t,n),l=function(e,t){for(let n of GARDENS)for(let a of n.tiles){let i={garden:n,tile:a};if(a.x==e&&a.y==t)return i;if(0==a.orient&&a.x==e-1&&a.y==t)return i}return null}(i.x,i.y);w=i.x,T=i.y,Garden_IsLinked(l)?a.classList.add("clickable"):a.classList.remove("clickable")}Array.prototype.random=function(){return this[Math.floor(Math.random()*this.length)]},document.addEventListener("DOMContentLoaded",(e=>{c(),function(){I=document.getElementById("bg0"),_=I.getContext("2d"),function(){const e=document.getElementById("mapcanvas");e.getContext&&(e.style.width="100%",e.style.height="100%",e.width=e.offsetWidth,e.height=e.offsetHeight)}();const e=document.getElementById("mapcanvas");e.getContext&&(e.onpointerdown=X,e.onpointerup=Y,e.onpointermove=H,p=performance.now(),v=p,window.requestAnimationFrame(W))}()}))})();